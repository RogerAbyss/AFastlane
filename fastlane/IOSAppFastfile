desc 'æµ‹è¯•ç‰ˆ,ä¸Šä¼ Fir'
override_lane :test do |options|

  # è·å–å‚æ•°
  lane          = ENV["FASTLANE_LANE_NAME"]
  adminer       = ENV["APP_ADMINER"]
  token         = ENV["APP_FIR_TOKEN"]
  scheme		   	= ENV["APP_SCHEME"]

	# è·å–æœ€æ–°çš„git
	# Warning åªä¼šå¤„ç†å½“å‰åˆ†æ”¯
	git_pull

	# æ›´æ–°ä¸‰æ–¹åº“æ–‡ä»¶
	pod_update

  # ä¿®æ”¹Appæœ¬åœ°é…ç½®ä¿¡æ¯
  change

  # åŒ¹é…è¯ä¹¦
  match
  # ç¼–è¯‘/æ‰“åŒ…
  gym


  # ä¸Šä¼ Fir
  path  = lane_context[SharedValues::IPA_OUTPUT_PATH]
  msg   = "[#{lane}] - automatic build by #{adminer}"

  UI.important "Upload Fir.im\n#{msg}"

  system "fir publish #{path} -T #{token} -c #{msg}"

  # è·å–ç‰ˆæœ¬å·
  version = get_version_number(xcodeproj: "#{scheme}.xcodeproj")
  UI.important "#{version}"
  # å‘é€é‚®ä»¶
  email(version: version)

  # æäº¤git
  git_add(path: '.')
  git_commit(path: '.', message: "chore: ğŸš€[#{lane}] - Automatic version UP")
end

# ======================================================================
# ======================================================================
# ======================================================================


desc 'é¢„å‘å¸ƒç‰ˆ(æµ‹è¯•æ­£å¼ç¯å¢ƒ),ä¸Šä¼ Fir'
override_lane :beta do |options|

	# è·å–å‚æ•°
  lane 			      = ENV["FASTLANE_LANE_NAME"]
  adminer         = ENV["APP_ADMINER"]
  token           = ENV["APP_FIR_TOKEN"]
  scheme		    	= ENV["APP_SCHEME"]

	# è·å–æœ€æ–°çš„git
	# Warning åªä¼šå¤„ç†å½“å‰åˆ†æ”¯
	git_pull

	# æ›´æ–°ä¸‰æ–¹åº“æ–‡ä»¶
	pod_update

  # ä¿®æ”¹Appæœ¬åœ°é…ç½®ä¿¡æ¯
  change

  # åŒ¹é…è¯ä¹¦
  match
  # ç¼–è¯‘/æ‰“åŒ…
  gym

  # ä¸Šä¼ Fir
  path  = lane_context[SharedValues::IPA_OUTPUT_PATH]
  msg   = "[#{lane}] - automatic build by #{adminer}"

  UI.important "Upload Fir.im\n#{msg}"

  system "fir publish #{path} -T #{token} -c #{msg}"

  # è·å–ç‰ˆæœ¬å·
  version = get_version_number(xcodeproj: "#{scheme}.xcodeproj")
  UI.important "#{version}"
  # å‘é€é‚®ä»¶
  email(version: version)

  # æäº¤git
  git_add(path: '.')
  git_commit(path: '.', message: "chore: ğŸš€[#{lane}] - Automatic version UP")
end

# ======================================================================
# ======================================================================
# ======================================================================


desc 'æ­£å¼æœ(ä½¿ç”¨å‰è¯·è‡ªè¡Œå¤„ç†å¥½æ‰€æœ‰çš„gitäº‹åŠ¡, é€‰æ‹©å‘å¸ƒçš„åˆ†æ”¯), ä¸Šä¼ AppStore'
override_lane :release do |options|

	# è·å–å‚æ•°
	lane 				  = ENV["FASTLANE_LANE_NAME"]
  adminer       = ENV["APP_ADMINER"]
  token         = ENV["APP_FIR_TOKEN"]
  appname 			= ENV["APP_NAME"]
  scheme		   	= ENV["APP_SCHEME"]

	# æ›´æ–°ä¸‰æ–¹åº“æ–‡ä»¶
	pod_update

  # ä¿®æ”¹Appé…ç½®, App-Storeå¾ˆå¤šä¸è¦ä¿®æ”¹ï¼
  change

	# è‡ªåŠ¨å¢åŠ ç‰ˆæœ¬å·
	# Warning è¯·ä½¿ç”¨x.x.xæ ‡å‡†ç‰ˆæœ¬å·
  increment_build_number
  increment_version_number

  # åŒ¹é…è¯ä¹¦
  match
  # ç¼–è¯‘/æ‰“åŒ…
  gym

  # ä¸Šä¼ AppStore
  deliver(force: false, skip_metadata: true, skip_screenshots: true)

  # è·å–ç‰ˆæœ¬å·
  version = get_version_number(xcodeproj: "#{scheme}.xcodeproj")
  UI.important "#{version}"
  # å‘é€é‚®ä»¶
  email(version: version)

  # æäº¤git
  git_add(path: '.')
  git_commit(path: '.', message: "chore: ğŸš€ğŸš€[AppStore] v#{version}")
end

# ======================================================================
# ======================================================================
# ======================================================================

desc 'åˆ·æ–°è¯ä¹¦, å¦‚æœå¤±è´¥è¯·äºç®¡ç†å‘˜è”ç³»'
override_lane :refresh do |options|

	UI.important "é‡åˆ°ä¸èƒ½è§£å†³çš„é—®é¢˜, fastlane match nuke development/distribution"

	match(type: "appstore")
	match(type: "adhoc")
	match(type: "development")
end

desc 'è®¾ç½®è¯ä¹¦(éç®¡ç†å‘˜, è¯·ä¸è¦ä½¿ç”¨æ­¤åŠŸèƒ½)'
override_lane :setting do |options|

	UI.important "é‡åˆ°ä¸èƒ½è§£å†³çš„é—®é¢˜, fastlane match nuke development/distribution"

	match(type:"appstore")
	match(type:"adhoc")
	match(type:"development")
end

desc 'å¢åŠ è®¾å¤‡, æ³¨æ„åˆ°å¼€å‘è€…ä¸­å¿ƒè¯ä¹¦æ·»åŠ å¹¶ä¸”åˆ·æ–°æœ¬åœ°ä½¿ç”¨è¯ä¹¦'
override_lane :devices do |options|
  register_devices(devices_file: './devices.txt')
end

# ======================================================================
# ======================================================================
# ======================================================================

desc 'ä¿®æ”¹Appæœ¬åœ°ä¿¡æ¯'
private_lane :change do |options|

	lane 				      = ENV["FASTLANE_LANE_NAME"]
	scheme		   	  	= ENV["APP_SCHEME"]
	appname 			    = ENV["APP_NAME"]
	appname_release 	= ENV["APP_NAME_RELEASE"]

	# å–ä¸åŒçš„APP_IDENTIFIER
	lane_key = lane.upcase
	app_identifier 		= ENV["APP_IDENTIFIER_#{lane_key}"]


	UI.important "å½“å‰ç‰ˆæœ¬:#{lane}"
	if lane.to_s == "release"
		appname = appname_release
	elsif
		appname = appname + lane
	end

	# æ­¤æ–¹æ³•å¹¶æ²¡æœ‰æˆåŠŸä¿®æ”¹ PRODUCT_BUNDLE_IDENTIFIER 
	# Warning - ç”¨æ­¤æ–¹æ³•ä¿®æ”¹app_identifier, åè€Œå¯¼è‡´PRODUCT_BUNDLE_IDENTIFIERé”™ä¹±æ— æ³•æˆåŠŸåŒ¹é…
	update_info_plist(
		plist_path: "#{scheme}/Info.plist",
      	display_name: appname,
      	# app_identifier: app_identifier,
  	)

  	update_app_identifier(
  		plist_path: "#{scheme}/Info.plist",
      	app_identifier: app_identifier,
  	)

  	UI.important "\nä¿®æ”¹AppDisplayName:#{appname}\nä¿®æ”¹Identifier:#{app_identifier}"

	# è‡ªåŠ¨å¢åŠ ç‰ˆæœ¬å·
	# Warning è¯·ä½¿ç”¨x.x.xæ ‡å‡†ç‰ˆæœ¬å·
  	increment_build_number
  	increment_version_number

end