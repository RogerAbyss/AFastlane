# Fastfile 
# Copyright@2017 Abyss

fastlane_version ENV["FASTLANE_VERSION_MIN"]
default_platform :ios

platform :ios do
	before_all do
	end

	desc '构建测试版'
	override_lane :test do |options|

		# 获取参数
		lane          = ENV["FASTLANE_LANE_NAME"]
		adminer       = ENV["APP_ADMINER"]
		token         = ENV["APP_FIR_TOKEN"]
		scheme		  = ENV["APP_SCHEME"]
	   
		# 确认git状态健康
		# 确认git分支正确
		# 
		before

		# complete

		# # 获取最新的git
		# # Warning 只会处理当前分支
		# git_pull
	   
		# # 更新三方库文件
		# pod_update
	   
		# # 修改App本地配置信息
		# change
	   
		# # 匹配证书
		# match

		# # 签名
		# enable_automatic_code_signing(
		# 	team_id: ENV["APP_TEAMID_TEST"]
		# )

		# # 编译/打包
		# gym
	   
	   
		#  # 上传Fir
		#  path  = lane_context[SharedValues::IPA_OUTPUT_PATH]
		#  msg   = "[#{lane}] - automatic build by #{adminer}"
	   
		#  UI.important "Upload Fir.im\n#{msg}"
	   
		#  system "fir publish #{path} -T #{token} -c #{msg}"
	   
		#  # 获取版本号
		#  version = get_version_number(xcodeproj: "#{scheme}.xcodeproj")
		#  UI.important "#{version}"
		#  # 发送邮件
		#  email(version: version)
	   
		#  # 提交git
		#  git_add(path: '.')
		#  git_commit(path: '.', message: "chore: 🚀[#{lane}] - Automatic version UP")
	end
	
	private_lane :before do |options|
		ensure_git_status_clean

		branch = ENV["APP_SETTING_GIT_BRANCH"]
		if branch.length > 0
			ensure_git_branch(
				branch: branch
		  	)
		end
	end

	after_all do
	end
end