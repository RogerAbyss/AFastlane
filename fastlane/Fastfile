# Fastfile 
# Copyright@2017 Abyss

fastlane_version ENV["FASTLANE_VERSION_MIN"]
default_platform :ios

platform :ios do
	before_all do
	end

	desc 'æ„å»ºæµ‹è¯•ç‰ˆ'
	override_lane :test do |options|

		UI.important("å½“å‰ç‰ˆæœ¬: æµ‹è¯•ç‰ˆ")

		# git ç¡®è®¤çŠ¶æ€å¥åº·
		# git åˆ‡æ¢æŒ‡å®šåˆ†æ”¯
		# git ç¡®è®¤åˆ†æ”¯æ­£ç¡®
		# git æ‹‰å–æœ€æ–°ä»£ç 
		# pod æ›´æ–°æœ¬åœ°ä¸‰æ–¹åº“
		# project ä¿®æ”¹å·¥ç¨‹DisplayName
		# project ä¿®æ”¹å·¥ç¨‹Identifier
		# project å¢åŠ ç‰ˆæœ¬å·/buildå·
		before
		version = get_version_number(xcodeproj: ENV["APP_PROJECT"])

		# åŒ¹é…è¯ä¹¦
		match

		# ç­¾å
		enable_automatic_code_signing(team_id: ENV["APP_TEAMID_TEST"])

		# ç¼–è¯‘
		gym(output_name: ENV["APP_NAME"] + "-test-" + version)

		complete
		#  # è·å–ç‰ˆæœ¬å·
		#  version = get_version_number(xcodeproj: "#{scheme}.xcodeproj")
		#  UI.important "#{version}"
		#  # å‘é€é‚®ä»¶
		#  email(version: version)
	   
		#  # æäº¤git
		#  git_add(path: '.')
		#  git_commit(path: '.', message: "chore: ğŸš€[#{lane}] - Automatic version UP")
	end
	
	private_lane :complete do |options|
		lane  = ENV["FASTLANE_LANE_NAME"]

		# ä¸Šä¼ ä¸‰æ–¹
		platform = ENV["APP_PLATFORM"]
		if platform.length > 0
			path  = lane_context[SharedValues::IPA_OUTPUT_PATH]
			msg   = "[#{lane}] - automatic build by #{ENV["APP_ADMINER"]}#{ENV["FASTLANE_FASTFILE_VERSION"]}"

			if platform == "fir.im"
				token = ENV["APP_FIR_TOKEN"]
				system "fir publish #{path} -T #{token} -c #{msg}"
			elsif platform == "pgyer.com"
				ukey = ENV["APP_PGYER_UKEY"]
				token = ENV["APP_PGYER_TOKEN"]
				system """
				curl -F 'file=#{path}' \
				-F 'uKey=#{ukey}' \
				-F '_api_key=#{token}' \
				https://www.pgyer.com/apiv1/app/upload
				"""
			end
		end
	end

	private_lane :before do |options|
		UI.important("è¯·ç¡®è®¤æ˜¯å¦è§£å†³å†²çªå¹¶ä¸”æäº¤æ‰€æœ‰æ”¹åŠ¨!")
		ensure_git_status_clean
		branch = ENV["APP_SETTING_GIT_BRANCH"]
		if branch.length > 0
			system("git checkout #{branch}")
			ensure_git_branch(
				branch: branch
		  	)
		end
		git_pull

		pod_update

		lane 				= ENV["FASTLANE_LANE_NAME"]
		appname 	  		= ENV["APP_NAME"]
		appname_release		= ENV["APP_NAME_RELEASE"]

		app_identifier = ENV["APP_IDENTIFIER_#{lane.upcase}"]
		if lane.to_s == "release"
			appname = appname_release
		else
			appname = appname + "-" + lane
		end
		update_info_plist(
			plist_path: ENV["APP_SCHEME"] + "/Info.plist",
			display_name: appname,
		)
		update_app_identifier(
			plist_path: ENV["APP_SCHEME"] + "/Info.plist",
			app_identifier: app_identifier,
		)
		UI.important "\nä¿®æ”¹AppDisplayName:#{appname}\nä¿®æ”¹Identifier:#{app_identifier}"
	
		if(ENV["APP_SETTING_VERSION_AUTO"])
			# Warning è¯·ä½¿ç”¨x.x.xæ ‡å‡†ç‰ˆæœ¬å·
			increment_build_number
			increment_version_number
		end
	end

	after_all do
	end
end