# Fastfile 
# Copyright@2017 Abyss

min_fastlane_version(ENV["FASTLANE_VERSION_MIN"])
default_platform :ios

platform :ios do
	before_all do
	end

	desc 'æµ‹è¯•'
	override_lane :try do |options|
	end

	desc 'ç™»å½•ä»¤ç‰Œè·å–'
	override_lane :auth do |options|
		command = "fastlane spaceauth -u #{ENV["FASTLANE_USER"]}"
		system command
	end

	desc 'æ„å»ºæµ‹è¯•ç‰ˆ'
	override_lane :test do |options|

		UI.important("ğŸš€ å½“å‰ç‰ˆæœ¬: æµ‹è¯•ç‰ˆ")

		# ğŸš€ git ç¡®è®¤çŠ¶æ€å¥åº·
		# ğŸš€ git åˆ‡æ¢æŒ‡å®šåˆ†æ”¯
		# ğŸš€ git ç¡®è®¤åˆ†æ”¯æ­£ç¡®
		# ğŸš€ git æ‹‰å–æœ€æ–°ä»£ç 
		# ğŸš€ pod æ›´æ–°æœ¬åœ°ä¸‰æ–¹åº“
		# ğŸš€ project ä¿®æ”¹å·¥ç¨‹DisplayName
		# ğŸš€ project ä¿®æ”¹å·¥ç¨‹Identifier
		# ğŸš€ project å¢åŠ ç‰ˆæœ¬å·/buildå·
		before
		version = get_version_number(xcodeproj: ENV["APP_PROJECT"])

		# ğŸš€ åŒ¹é…è¯ä¹¦
		match

		# ğŸš€ ç­¾å
		enable_automatic_code_signing(team_id: ENV["APP_TEAMID_TEST"])

		UI.important(ENV["APP_NAME"] + "-test-" + version)
		# ğŸš€ ç¼–è¯‘
		gym(output_name: ENV["APP_NAME"] + "-test-" + version)

		# ğŸš€ fir.im/pgyer.cpm ä¸Šä¼ ä¸‰æ–¹
		# ğŸš€ email notify
		# ğŸš€ git commit/push
		complete
	end
	desc 'æ„å»ºé¢„å‘å¸ƒ'
	override_lane :beta do |options|

		UI.important("ğŸš€ å½“å‰ç‰ˆæœ¬: é¢„å‘å¸ƒ")

		# ğŸš€ git ç¡®è®¤çŠ¶æ€å¥åº·
		# ğŸš€ git åˆ‡æ¢æŒ‡å®šåˆ†æ”¯
		# ğŸš€ git ç¡®è®¤åˆ†æ”¯æ­£ç¡®
		# ğŸš€ git æ‹‰å–æœ€æ–°ä»£ç 
		# ğŸš€ pod æ›´æ–°æœ¬åœ°ä¸‰æ–¹åº“
		# ğŸš€ project ä¿®æ”¹å·¥ç¨‹DisplayName
		# ğŸš€ project ä¿®æ”¹å·¥ç¨‹Identifier
		# ğŸš€ project å¢åŠ ç‰ˆæœ¬å·/buildå·
		before
		version = get_version_number(xcodeproj: ENV["APP_PROJECT"])

		# ğŸš€ åŒ¹é…è¯ä¹¦
		match

		# ğŸš€ ç­¾å
		enable_automatic_code_signing(team_id: ENV["APP_TEAMID_BETA"])

		UI.important(ENV["APP_NAME"] + "-beta-" + version)
		# ğŸš€ ç¼–è¯‘
		gym(output_name: ENV["APP_NAME"] + "-beta-" + version)

		# ğŸš€ fir.im/pgyer.cpm ä¸Šä¼ ä¸‰æ–¹
		# ğŸš€ email notify
		# ğŸš€ git commit/push
		complete
	end
	
	desc 'æ„å»ºæ­£å¼æœ'
	override_lane :release do |options|
		UI.important("ğŸš€ å½“å‰ç‰ˆæœ¬: æ­£å¼æœ")

		appstore_upload
	end

		
	desc 'æ„å»ºtestflight'
	override_lane :testf do |options|
		UI.important("ğŸš€ å½“å‰ç‰ˆæœ¬: Testflight")

		appstore_upload
	end

	desc 'appstoreèµ„æ–™ä¸Šä¼ '
	override_lane :upload do |options|
		UI.important("ğŸš€ appstoreèµ„æ–™ä¸Šä¼ ")

		# æˆªå›¾
		capture_screenshots
		frame_screenshots
	end
	
	private_lane :appstore_upload do |options|
		
		# ğŸš€ git ç¡®è®¤çŠ¶æ€å¥åº·
		# ğŸš€ git åˆ‡æ¢æŒ‡å®šåˆ†æ”¯
		# ğŸš€ git ç¡®è®¤åˆ†æ”¯æ­£ç¡®
		# ğŸš€ git æ‹‰å–æœ€æ–°ä»£ç 
		# ğŸš€ pod æ›´æ–°æœ¬åœ°ä¸‰æ–¹åº“
		# ğŸš€ project ä¿®æ”¹å·¥ç¨‹DisplayName
		# ğŸš€ project ä¿®æ”¹å·¥ç¨‹Identifier
		# ğŸš€ project å¢åŠ ç‰ˆæœ¬å·/buildå·
		before
		version = get_version_number(xcodeproj: ENV["APP_PROJECT"])

		# ğŸš€ åŒ¹é…è¯ä¹¦
		match

		# ğŸš€ ç­¾å
		enable_automatic_code_signing(team_id: ENV["APP_TEAMID_RELEASE"])

		# ğŸš€ ç¼–è¯‘
		gym(output_name: ENV["APP_NAME"] + "-" + version)

		# ğŸš€ appstore
		# ğŸš€ testfighting
		# ğŸš€ fir.im/pgyer.cpm ä¸Šä¼ ä¸‰æ–¹
		# ğŸš€ email notify
		# ğŸš€ git commit/push
		complete
	end

	private_lane :complete do |options|
		lane  = ENV["FASTLANE_LANE_NAME"]
		msg	  = last_git_commit[:message]

		if lane == "release"
			pem(
				app_identifier: ENV["APP_IDENTIFIER_RELEASE"],
				team_id: ENV["APP_TEAMID_RELEASE"],
				output_path: ENV["APP_SETTING_PUSH_PATH"],
			)
			appstore(force: false, skip_metadata: true, skip_screenshots: true)
		elsif lane == "testf"
			upload_to_testflight(team_id: ENV["APP_IDENTIFIER_TESTFLIGHT"],
								 skip_waiting_for_build_processing: true,
								 changelog: msg,
								 )
		else
			# ä¸Šä¼ ä¸‰æ–¹
			platform = ENV["APP_PLATFORM"]
			if platform.length > 0
				path  = lane_context[SharedValues::IPA_OUTPUT_PATH]
				UI.important("ipa:" + path)
				msg   = "[#{lane}] - automatic build by #{ENV["APP_ADMINER"]}#{ENV["FASTLANE_FASTFILE_VERSION"]}"

				command = ""
				if platform == "fir.im"
					UI.important("ğŸš€ ä¸Šä¼ Fir.im")
					token = ENV["APP_FIR_TOKEN"]

					command = "fir publish #{path} -T #{token} -c #{msg}"
				elsif platform == "pgyer.com"
					UI.important("ğŸš€ ä¸Šä¼ pgyer.com")
					ukey = ENV["APP_PGYER_UKEY"]
					token = ENV["APP_PGYER_TOKEN"]


					command = "curl -F 'file=@#{path}'\
					-F 'uKey=#{ukey}'\
					-F '_api_key=#{token}'\
					https://www.pgyer.com/apiv1/app/upload"
				end

				UI.important(command)
				system command
			end
		end

		useEmail = ENV["APP_SETTING_EMAIL_NOTIFY"]
		if useEmail == "true"
			email(
				version: get_version_number(xcodeproj: ENV["APP_PROJECT"]),
				commitmsg: msg,
				)
		end

		UI.important("ğŸš€ gitä¿®æ”¹æäº¤")
		git_add(path: '.')
		git_commit(path: '.', message: "chore: ğŸš€[#{lane}] - è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬(ä¿®æ”¹å·¥ç¨‹ç‰ˆæœ¬å·ç­‰)")
		push_to_git_remote

		# tag
		if lane == "release" && (ENV["APP_SETTING_TAG"] == "true")
			add_git_tag
		end
	end

	private_lane :before do |options|
		# gitæ“ä½œ
		UI.important("ğŸš€ è¯·ç¡®è®¤æ˜¯å¦è§£å†³å†²çªå¹¶ä¸”æäº¤æ‰€æœ‰æ”¹åŠ¨!")
		ensure_git_status_clean
		branch = ENV["APP_SETTING_GIT_BRANCH"]
		if branch.length > 0
			system("git checkout #{branch}")
			ensure_git_branch(
				branch: branch
		  	)
		end
		git_pull

		pod_update

		# ä¿®æ”¹å·¥ç¨‹(ç‰ˆæœ¬å·/appåå­—/identifierç­‰)
		lane 				= ENV["FASTLANE_LANE_NAME"]
		appname 	  		= ENV["APP_NAME"]
		appname_release		= ENV["APP_NAME_RELEASE"]

		UI.important("lane is #{lane.upcase}")
		app_identifier = ENV["APP_IDENTIFIER_#{lane.upcase}"]
		if lane.to_s == "release" || lane.to_s == "testf"
			appname = appname_release
		else
			appname = appname + "-" + lane
		end
		update_info_plist(
			plist_path: ENV["APP_SCHEME"] + "/Info.plist",
			display_name: appname,
		)
		update_app_identifier(
			plist_path: ENV["APP_SCHEME"] + "/Info.plist",
			app_identifier: app_identifier,
		)
		UI.important "\nä¿®æ”¹AppDisplayName:#{appname}\nä¿®æ”¹Identifier:#{app_identifier}"
	
		if(ENV["APP_SETTING_VERSION_AUTO"] == "true")
			# Warning è¯·ä½¿ç”¨x.x.xæ ‡å‡†ç‰ˆæœ¬å·
			UI.important("ğŸš€ è‡ªåŠ¨å¢é•¿ç‰ˆæœ¬å·")
			increment_build_number
			increment_version_number
		end

		devices = ENV["APP_SETTING_DEVICES"]
		if devices.length > 0
			register_devices(devices)
		end
	end

	after_all do
	end
end